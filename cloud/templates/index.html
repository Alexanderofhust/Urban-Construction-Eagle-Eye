<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå¸‚å»ºè®¾é¹°çœ¼ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- é«˜å¾·åœ°å›¾ JS API Loader -->
    <script src="https://webapi.amap.com/loader.js"></script>
    <!-- é«˜å¾·åœ°å›¾3Då®‰å…¨é…ç½® -->
    <script> 
        window._AMapSecurityConfig = {
            securityJsCode: '290ddc4b0d33be7bc9b354bc6a4ca614',
        }
    </script>
</head>
<body>
    <div class="app-container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="nav-brand">
                <h1>ğŸ¦… åŸå¸‚å»ºè®¾é¹°çœ¼ç³»ç»Ÿ</h1>
            </div>
            <div class="nav-menu">
                <button class="nav-btn active" data-page="dashboard">æ€»è§ˆ</button>
                <button class="nav-btn" data-page="pointcloud">ç‚¹äº‘å¯è§†åŒ–</button>
                <button class="nav-btn" data-page="review">ç¼ºé™·å¤æ£€</button>
                <button class="nav-btn" data-page="analysis">AIåˆ†æ</button>
                <button class="nav-btn" data-page="statistics">ç»Ÿè®¡æŠ¥å‘Š</button>
            </div>
            <div class="nav-status">
                <span id="connection-status" class="status-indicator disconnected">æœªè¿æ¥</span>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æ€»è§ˆé¡µé¢ -->
            <div id="dashboard-page" class="page active">
                <div class="dashboard-header">
                    <h2>ç³»ç»Ÿæ€»è§ˆ</h2>
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ“Š</div>
                            <div class="stat-info">
                                <div class="stat-number" id="total-sessions">0</div>
                                <div class="stat-label">ä¼šè¯æ•°é‡</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ—ï¸</div>
                            <div class="stat-info">
                                <div class="stat-number" id="total-defects">0</div>
                                <div class="stat-label">å‘ç°ç¼ºé™·</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">âœ…</div>
                            <div class="stat-info">
                                <div class="stat-number" id="reviewed-count">0</div>
                                <div class="stat-label">å·²å¤æ£€</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-content">
                    <div class="control-panel">
                        <h3>è¿æ¥æ§åˆ¶</h3>
                        <form id="connection-form" class="connection-form">
                            <div class="form-group">
                                <label for="host">ä¸‹ä½æœºIPåœ°å€:</label>
                                <input type="text" id="host" name="host" placeholder="192.168.1.100" required>
                            </div>
                            <div class="form-group">
                                <label for="username">ç”¨æˆ·å:</label>
                                <input type="text" id="username" name="username" placeholder="ubuntu" required>
                            </div>
                            <div class="form-group">
                                <label for="password">å¯†ç :</label>
                                <input type="password" id="password" name="password" required>
                            </div>
                            <div class="form-group">
                                <label for="data-path">æ•°æ®è·¯å¾„:</label>
                                <input type="text" id="data-path" name="data_path" placeholder="/home/ubuntu/data" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="connect-btn">
                                <span class="btn-text">è¿æ¥å¹¶ä¸‹è½½æ•°æ®</span>
                                <span class="btn-loading" style="display: none;">è¿æ¥ä¸­...</span>
                            </button>
                        </form>
                        
                        <div id="progress-container" class="progress-container" style="display: none;">
                            <div class="progress-label">ä¸‹è½½è¿›åº¦</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text" id="progress-text">0%</div>
                        </div>
                    </div>

                    <div class="sessions-panel">
                        <h3>ä¼šè¯åˆ—è¡¨</h3>
                        <div id="sessions-list" class="sessions-list">
                            <!-- ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç‚¹äº‘å¯è§†åŒ–é¡µé¢ -->
            <div id="pointcloud-page" class="page">
                <div class="page-header">
                    <h2>ç‚¹äº‘å¯è§†åŒ–</h2>
                    <div class="page-controls">
                        <select id="session-selector" class="select-input">
                            <option value="">é€‰æ‹©ä¼šè¯</option>
                        </select>
                        <button id="load-pointcloud-btn" class="btn btn-primary">åŠ è½½ç‚¹äº‘</button>
                    </div>
                </div>
                
                <div class="pointcloud-container">
                    <div class="pointcloud-viewer">
                        <div id="pointcloud-canvas" class="canvas-container"></div>
                        <div class="viewer-controls">
                            <button id="reset-view-btn" class="btn btn-secondary">é‡ç½®è§†è§’</button>
                            <button id="toggle-colors-btn" class="btn btn-secondary">åˆ‡æ¢é¢œè‰²</button>
                        </div>
                    </div>
                    
                    <div class="pointcloud-info">
                        <h4>ç‚¹äº‘ä¿¡æ¯</h4>
                        <div id="pointcloud-stats" class="info-panel">
                            <div class="info-item">
                                <span class="info-label">ç‚¹æ•°é‡:</span>
                                <span class="info-value" id="points-count">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åŒ…å›´ç›’:</span>
                                <span class="info-value" id="bounding-box">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ä¸­å¿ƒç‚¹:</span>
                                <span class="info-value" id="center-point">-</span>
                            </div>
                        </div>
                        
                        <div class="map-container">
                            <div class="map-header">
                                <h4>ğŸ—ºï¸ 3Dåœ°å›¾ä½ç½®</h4>
                                <div class="map-controls">
                                    <button class="btn-icon" onclick="toggleMapView()" title="åˆ‡æ¢2D/3Dè§†å›¾">
                                        <span id="map-view-icon">ğŸŒ</span>
                                    </button>
                                    <button class="btn-icon" onclick="toggleBuildingEffect()" title="åˆ‡æ¢å»ºç­‘ç‰¹æ•ˆ">
                                        <span id="effect-icon">âœ¨</span>
                                    </button>
                                    <button class="btn-icon" onclick="openFullscreenMap()" title="å…¨å±åœ°å›¾">
                                        <span>ğŸ”</span>
                                    </button>
                                </div>
                            </div>
                            <div id="amap-container" class="map-view"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¼ºé™·å¤æ£€é¡µé¢ -->
            <div id="review-page" class="page">
                <div class="page-header">
                    <h2>ç¼ºé™·å¤æ£€</h2>
                    <div class="page-controls">
                        <select id="review-session-selector" class="select-input">
                            <option value="">é€‰æ‹©ä¼šè¯</option>
                        </select>
                        <button id="load-defects-btn" class="btn btn-primary">åŠ è½½ç¼ºé™·</button>
                    </div>
                </div>
                
                <div class="review-container">
                    <div class="defects-list">
                        <h4>ç¼ºé™·åˆ—è¡¨ (æŒ‰ä¸¥é‡ç¨‹åº¦æ’åº)</h4>
                        <div id="defects-list" class="defects-grid">
                            <!-- ç¼ºé™·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="review-panel" id="review-panel" style="display: none;">
                        <div class="review-header">
                            <h4>ç¼ºé™·è¯¦æƒ…</h4>
                            <div class="defect-severity">
                                <span class="severity-label">ä¸¥é‡ç¨‹åº¦:</span>
                                <span class="severity-value" id="current-severity">-</span>
                            </div>
                        </div>
                        
                        <div class="review-images">
                            <div class="image-panel">
                                <h5>åŸå§‹å›¾åƒ</h5>
                                <img id="original-image" class="review-image" alt="åŸå§‹å›¾åƒ">
                            </div>
                            <div class="image-panel">
                                <h5>ç¼ºé™·æ ‡æ³¨</h5>
                                <img id="overlay-image" class="review-image" alt="å åŠ å›¾åƒ">
                            </div>
                        </div>
                        
                        <div class="review-actions">
                            <button id="approve-btn" class="btn btn-success">âœ… é€šè¿‡</button>
                            <button id="reject-btn" class="btn btn-danger">âŒ ä¸é€šè¿‡</button>
                            <div class="review-progress">
                                <span id="review-progress-text">0/0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIåˆ†æé¡µé¢ -->
            <div id="analysis-page" class="page">
                <div class="page-header">
                    <h2>AIæ™ºèƒ½åˆ†æ</h2>
                    <div class="page-controls">
                        <select id="analysis-session-selector" class="select-input">
                            <option value="">é€‰æ‹©ä¼šè¯</option>
                        </select>
                        <button id="start-analysis-btn" class="btn btn-primary">å¼€å§‹åˆ†æ</button>
                    </div>
                </div>
                
                <div class="analysis-container">
                    <div id="analysis-loading" class="loading-container" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>AIæ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                    </div>
                    
                    <div id="analysis-results" class="analysis-results" style="display: none;">
                        <div class="analysis-header">
                            <h3>åˆ†ææŠ¥å‘Š</h3>
                            <div class="condition-badge" id="condition-badge">
                                <span class="condition-text" id="condition-text">è‰¯å¥½</span>
                                <span class="condition-score" id="condition-score">8.5</span>
                            </div>
                        </div>
                        
                        <div class="analysis-content">
                            <div class="analysis-section">
                                <h4>å»ºç­‘ç‰©æè¿°</h4>
                                <p id="building-description" class="analysis-text"></p>
                            </div>
                            
                            <div class="analysis-section">
                                <h4>å‘ç°çš„ç¼ºé™·</h4>
                                <ul id="defects-found" class="defects-list"></ul>
                            </div>
                            
                            <div class="analysis-section">
                                <h4>ç»´ä¿®å»ºè®®</h4>
                                <ul id="repair-suggestions" class="suggestions-list"></ul>
                            </div>
                            
                            <div class="urgency-section">
                                <h4>ç´§æ€¥ç¨‹åº¦</h4>
                                <div class="urgency-indicator" id="urgency-indicator">
                                    <span class="urgency-level" id="urgency-level">ä¸­</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡æŠ¥å‘Šé¡µé¢ -->
            <div id="statistics-page" class="page">
                <div class="page-header">
                    <h2>ç»Ÿè®¡æŠ¥å‘Š</h2>
                    <div class="page-controls">
                        <select id="stats-session-selector" class="select-input">
                            <option value="">é€‰æ‹©ä¼šè¯</option>
                        </select>
                        <button id="generate-report-btn" class="btn btn-primary">ç”ŸæˆæŠ¥å‘Š</button>
                    </div>
                </div>
                
                <div class="statistics-container">
                    <div class="stats-grid">
                        <div class="stat-panel">
                            <h4>åŸºç¡€ç»Ÿè®¡</h4>
                            <div class="stat-items">
                                <div class="stat-item">
                                    <span class="stat-label">æ€»å›¾åƒæ•°:</span>
                                    <span class="stat-value" id="stat-total-images">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æ€»ç¼ºé™·æ•°:</span>
                                    <span class="stat-value" id="stat-total-defects">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å·²å¤æ£€æ•°:</span>
                                    <span class="stat-value" id="stat-reviewed">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é€šè¿‡ç‡:</span>
                                    <span class="stat-value" id="stat-pass-rate">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-panel">
                            <h4>ç¼ºé™·åˆ†å¸ƒ</h4>
                            <div class="defect-distribution">
                                <div class="defect-type">
                                    <span class="defect-color red"></span>
                                    <span class="defect-name">ä¸¥é‡ç¼ºé™·</span>
                                    <span class="defect-count" id="red-defects">0</span>
                                </div>
                                <div class="defect-type">
                                    <span class="defect-color blue"></span>
                                    <span class="defect-name">ä¸­ç­‰ç¼ºé™·</span>
                                    <span class="defect-count" id="blue-defects">0</span>
                                </div>
                                <div class="defect-type">
                                    <span class="defect-color green"></span>
                                    <span class="defect-name">è½»å¾®ç¼ºé™·</span>
                                    <span class="defect-count" id="green-defects">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="/static/js/main.js"></script>
    <script src="/static/js/pointcloud.js"></script>
    <script src="/static/js/review.js"></script>
    <script src="/static/js/analysis.js"></script>
    <script src="/static/js/statistics.js"></script>
    
    <!-- é«˜å¾·åœ°å›¾åˆå§‹åŒ– -->
    <script type="text/javascript">
        // è®¾ç½®å®‰å…¨å¯†é’¥ï¼ˆä»é…ç½®ä¸­è·å–ï¼‰
        // è®¾ç½®é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥
        window._AMapSecurityConfig = {
            securityJsCode: "{{ amap_security_key or 'your_security_js_code_here' }}",
        };
        
        // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
        AMapLoader.load({
            key: "{{ amap_api_key or '6f025e700cbacbb0bb866712d20bb35c' }}", // é«˜å¾·åœ°å›¾APIå¯†é’¥
            version: "2.0", // æŒ‡å®šè¦åŠ è½½çš„ JS API çš„ç‰ˆæœ¬
            plugins: ["AMap.Scale", "AMap.ToolBar", "AMap.Marker", "AMap.CircleMarker", "AMap.Geocoder", "AMap.Rectangle", "AMap.ControlBar", "AMap.Polyline", "AMap.Polygon"], // éœ€è¦ä½¿ç”¨çš„æ’ä»¶åˆ—è¡¨
            AMapUI: {
                version: '1.1',
                plugins: []
            }
        }).then((AMap) => {
            // åœ°å›¾åŠ è½½æˆåŠŸåçš„å›è°ƒ
            console.log('é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸ');
            window.AMap = AMap; // å°†AMapå¯¹è±¡ç»‘å®šåˆ°å…¨å±€
            
            // åˆå§‹åŒ–3Dåœ°å›¾å®ä¾‹
            if (document.getElementById('amap-container')) {
                window.mapInstance = new AMap.Map('amap-container', {
                    rotateEnable: true,
                    pitchEnable: true,
                    zoom: 17,
                    pitch: 50,
                    rotation: -15,
                    viewMode: '3D', // å¼€å¯3Dè§†å›¾
                    zooms: [2, 20],
                    center: [116.397428, 39.90923], // åŒ—äº¬å¤©å®‰é—¨  
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true,
                    zoomEnable: true,
                    dragEnable: true,
                    showBuildingBlock: true, // æ˜¾ç¤ºå»ºç­‘ç‰©
                    features: ['bg', 'road', 'building', 'point'] // æ˜¾ç¤ºèƒŒæ™¯ã€é“è·¯ã€å»ºç­‘ç‰©ã€æ ‡æ³¨
                });
                
                // æ·»åŠ 3Dæ§åˆ¶æ 
                const controlBar = new AMap.ControlBar({
                    position: {
                        right: '10px',
                        top: '10px'
                    }
                });
                controlBar.addTo(window.mapInstance);
                
                // æ·»åŠ å·¥å…·æ 
                const toolBar = new AMap.ToolBar({
                    position: {
                        right: '40px',
                        top: '110px'
                    }
                });
                toolBar.addTo(window.mapInstance);
                
                // æ·»åŠ æ¯”ä¾‹å°º
                window.mapInstance.addControl(new AMap.Scale());
                
                // å»ºç­‘ç‰©ç‰¹æ•ˆå›¾å±‚ç›¸å…³å˜é‡
                window.buildingHighlightLayer = null;
                window.pathAnimations = [];
                window.highlightPolygons = [];
                
                // æ·»åŠ åœ°å›¾æ•°æ®åŠ è½½åŠŸèƒ½
                window.loadLocationData = function(sessionId) {
                    if (!window.mapInstance) {
                        console.error('åœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–');
                        return;
                    }
                    
                    fetch(`/api/location/${sessionId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.location) {
                                updateMapWithLocation(data.location);
                                // åˆ›å»ºå»ºç­‘ç‰©ç‰¹æ•ˆé«˜äº®
                                createBuildingHighlight(data.location);
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½ä½ç½®æ•°æ®å¤±è´¥:', error);
                        });
                };
                
                // åˆ›å»ºå»ºç­‘ç‰©ç‰¹æ•ˆé«˜äº®æ˜¾ç¤º
                function createBuildingHighlight(locationData) {
                    if (!window.effectsEnabled || !locationData.points || locationData.points.length < 2) {
                        console.warn('ç‰¹æ•ˆå·²å…³é—­æˆ–éœ€è¦è‡³å°‘2ä¸ªç‚¹æ‰èƒ½åˆ›å»ºå»ºç­‘ç‰©é«˜äº®');
                        return;
                    }
                    
                    // æ¸…é™¤ä¹‹å‰çš„ç‰¹æ•ˆ
                    clearBuildingHighlight();
                    
                    const points = locationData.points.map(point => [point.lon, point.lat]);
                    
                    // åˆ›å»ºè¿æ¥è·¯å¾„çš„åŠ¨æ€çº¿æ¡
                    createAnimatedPath(points);
                    
                    // åˆ›å»ºå»ºç­‘ç‰©åŒºåŸŸé«˜äº®å¤šè¾¹å½¢
                    createHighlightPolygon(points);
                    
                    // æ·»åŠ ç‰¹æ•ˆæ ‡è®°ç‚¹
                    addEffectMarkers(points);
                    
                    // å¯åŠ¨è„‰å†²åŠ¨ç”»
                    startPulseAnimation();
                    
                    console.log(`å»ºç­‘ç‰©ç‰¹æ•ˆé«˜äº®å·²åˆ›å»ºï¼Œè¿æ¥ ${points.length} ä¸ªç‚¹`);
                }
                
                // åˆ›å»ºåŠ¨æ€è·¯å¾„çº¿æ¡
                function createAnimatedPath(points) {
                    // åˆ›å»ºä¸»è·¯å¾„çº¿
                    const pathLine = new AMap.Polyline({
                        path: points,
                        strokeColor: '#00FF00',    // ç»¿è‰²ä¸»çº¿
                        strokeWeight: 4,
                        strokeOpacity: 0.8,
                        strokeStyle: 'solid',
                        zIndex: 100
                    });
                    
                    // åˆ›å»ºåŠ¨ç”»æ•ˆæœçº¿
                    const animationLine = new AMap.Polyline({
                        path: points,
                        strokeColor: '#FFFF00',    // é»„è‰²åŠ¨ç”»çº¿
                        strokeWeight: 6,
                        strokeOpacity: 0.6,
                        strokeStyle: 'dashed',
                        zIndex: 99
                    });
                    
                    window.mapInstance.add([pathLine, animationLine]);
                    window.pathAnimations.push(pathLine, animationLine);
                    
                    // æ·»åŠ çº¿æ¡æµåŠ¨åŠ¨ç”»
                    let offset = 0;
                    const animateInterval = setInterval(() => {
                        offset += 5;
                        if (offset > 50) offset = 0;
                        
                        animationLine.setOptions({
                            strokeDasharray: [10, 10],
                            strokeDashoffset: offset
                        });
                    }, 100);
                    
                    window.pathAnimations.push({ type: 'interval', interval: animateInterval });
                }
                
                // åˆ›å»ºé«˜äº®å¤šè¾¹å½¢åŒºåŸŸ
                function createHighlightPolygon(points) {
                    // åˆ›å»ºå»ºç­‘ç‰©è½®å»“å¤šè¾¹å½¢
                    const highlightPolygon = new AMap.Polygon({
                        path: points,
                        strokeColor: '#FF0000',     // çº¢è‰²è¾¹æ¡†
                        strokeWeight: 3,
                        strokeOpacity: 0.9,
                        fillColor: '#FF0000',       // çº¢è‰²å¡«å……
                        fillOpacity: 0.2,
                        zIndex: 90
                    });
                    
                    window.mapInstance.add(highlightPolygon);
                    window.highlightPolygons.push(highlightPolygon);
                    
                    // æ·»åŠ å‘¼å¸æ•ˆæœ
                    let breathOpacity = 0.2;
                    let breathDirection = 1;
                    const breatheInterval = setInterval(() => {
                        breathOpacity += 0.02 * breathDirection;
                        if (breathOpacity >= 0.4) breathDirection = -1;
                        if (breathOpacity <= 0.1) breathDirection = 1;
                        
                        highlightPolygon.setOptions({
                            fillOpacity: breathOpacity
                        });
                    }, 50);
                    
                    window.pathAnimations.push({ type: 'interval', interval: breatheInterval });
                }
                
                // æ·»åŠ ç‰¹æ•ˆæ ‡è®°ç‚¹
                function addEffectMarkers(points) {
                    points.forEach((point, index) => {
                        // åˆ›å»ºå‘å…‰æ•ˆæœæ ‡è®°
                        const glowMarker = new AMap.CircleMarker({
                            center: point,
                            radius: 8,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2,
                            fillColor: index === 0 ? '#00FF00' : (index === points.length - 1 ? '#FF0000' : '#FFFF00'),
                            fillOpacity: 0.8,
                            zIndex: 110
                        });
                        
                        // åˆ›å»ºå¤–å±‚å…‰æ™•
                        const haloMarker = new AMap.CircleMarker({
                            center: point,
                            radius: 15,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 1,
                            fillColor: index === 0 ? '#00FF00' : (index === points.length - 1 ? '#FF0000' : '#FFFF00'),
                            fillOpacity: 0.3,
                            zIndex: 105
                        });
                        
                        window.mapInstance.add([glowMarker, haloMarker]);
                        window.highlightPolygons.push(glowMarker, haloMarker);
                        
                        // æ·»åŠ æ ‡è®°åŠ¨ç”»
                        let pulseSize = 8;
                        let pulseDirection = 1;
                        const pulseInterval = setInterval(() => {
                            pulseSize += 0.5 * pulseDirection;
                            if (pulseSize >= 12) pulseDirection = -1;
                            if (pulseSize <= 8) pulseDirection = 1;
                            
                            glowMarker.setRadius(pulseSize);
                            haloMarker.setRadius(pulseSize + 7);
                        }, 100);
                        
                        window.pathAnimations.push({ type: 'interval', interval: pulseInterval });
                    });
                }
                
                // å¯åŠ¨è„‰å†²åŠ¨ç”»
                function startPulseAnimation() {
                    // å…¨å±€è„‰å†²æ•ˆæœè®¡æ—¶å™¨å·²åœ¨å„ä¸ªç»„ä»¶ä¸­ç‹¬ç«‹å®ç°
                    console.log('å»ºç­‘ç‰©ç‰¹æ•ˆåŠ¨ç”»å·²å¯åŠ¨');
                }
                
                // æ¸…é™¤å»ºç­‘ç‰©é«˜äº®æ•ˆæœ
                function clearBuildingHighlight() {
                    // æ¸…é™¤åŠ¨ç”»è®¡æ—¶å™¨
                    window.pathAnimations.forEach(item => {
                        if (item.type === 'interval') {
                            clearInterval(item.interval);
                        } else if (item.remove) {
                            window.mapInstance.remove(item);
                        }
                    });
                    window.pathAnimations = [];
                    
                    // æ¸…é™¤å¤šè¾¹å½¢å’Œæ ‡è®°
                    if (window.highlightPolygons.length > 0) {
                        window.mapInstance.remove(window.highlightPolygons);
                        window.highlightPolygons = [];
                    }
                }
                
                // æ›´æ–°åœ°å›¾ä½ç½®æ•°æ®
                function updateMapWithLocation(locationData) {
                    // æ¸…é™¤ä¹‹å‰çš„è¦†ç›–ç‰©(ä½†ä¸æ¸…é™¤ç‰¹æ•ˆ)
                    const overlays = window.mapInstance.getAllOverlays();
                    overlays.forEach(overlay => {
                        if (overlay.getOptions && !overlay.getOptions().zIndex) {
                            window.mapInstance.remove(overlay);
                        }
                    });
                    
                    if (locationData.bounds) {
                        // åˆ›å»ºåŒ…å›´æ¡†
                        const rectangle = new AMap.Rectangle({
                            bounds: new AMap.Bounds(
                                [locationData.bounds.southwest.lon, locationData.bounds.southwest.lat],
                                [locationData.bounds.northeast.lon, locationData.bounds.northeast.lat]
                            ),
                            strokeColor: '#0066FF',
                            strokeWeight: 2,
                            strokeOpacity: 0.8,
                            fillColor: '#0066FF',
                            fillOpacity: 0.1,
                            zIndex: 50
                        });
                        
                        window.mapInstance.add(rectangle);
                        
                        // è°ƒæ•´åœ°å›¾è§†é‡åˆ°3Dè§†è§’
                        window.mapInstance.setBounds(rectangle.getBounds(), false, [50, 50, 50, 50]);
                        
                        // è®¾ç½®3Dè§†è§’
                        setTimeout(() => {
                            window.mapInstance.setPitch(60);
                            window.mapInstance.setRotation(-20);
                        }, 1000);
                    }
                    
                    // æ·»åŠ ä¸­å¿ƒç‚¹æ ‡è®°
                    if (locationData.center) {
                        const centerMarker = new AMap.Marker({
                            position: [locationData.center.lon, locationData.center.lat],
                            title: 'æ£€æµ‹åŒºåŸŸä¸­å¿ƒ',
                            icon: new AMap.Icon({
                                size: new AMap.Size(32, 38),
                                image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
                            }),
                            zIndex: 120
                        });
                        
                        window.mapInstance.add(centerMarker);
                        
                        // æ·»åŠ ä¸­å¿ƒç‚¹ä¿¡æ¯çª—ä½“
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 10px;">
                                    <h4 style="margin: 0 0 5px 0; color: #333;">ğŸ—ï¸ å»ºç­‘æ£€æµ‹åŒºåŸŸ</h4>
                                    <p style="margin: 5px 0; font-size: 12px;">åæ ‡: ${locationData.center.lat.toFixed(6)}, ${locationData.center.lon.toFixed(6)}</p>
                                    <p style="margin: 5px 0; font-size: 12px;">æ£€æµ‹ç‚¹æ•°: ${locationData.total_points || 0}</p>
                                    <p style="margin: 5px 0; font-size: 12px;">çŠ¶æ€: <span style="color: #00AA00;">ğŸŸ¢ æ´»è·ƒç›‘æµ‹</span></p>
                                </div>
                            `,
                            offset: new AMap.Pixel(0, -30)
                        });
                        
                        centerMarker.on('click', () => {
                            infoWindow.open(window.mapInstance, centerMarker.getPosition());
                        });
                    }
                    
                    console.log(`3Dåœ°å›¾å·²æ›´æ–°ï¼Œæ˜¾ç¤º ${locationData.total_points || 0} ä¸ªä½ç½®ç‚¹`);
                }
                
                console.log('3Dåœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸ');
                
                // å…¨å±€å˜é‡ç”¨äºæ§åˆ¶ç‰¹æ•ˆ
                window.is3DMode = true;
                window.effectsEnabled = true;
            }
            
            // åˆ‡æ¢2D/3Dè§†å›¾
            window.toggleMapView = function() {
                if (!window.mapInstance) return;
                
                window.is3DMode = !window.is3DMode;
                const viewIcon = document.getElementById('map-view-icon');
                
                if (window.is3DMode) {
                    // åˆ‡æ¢åˆ°3Dè§†å›¾
                    window.mapInstance.setViewMode('3D');
                    window.mapInstance.setPitch(50);
                    window.mapInstance.setRotation(-15);
                    viewIcon.textContent = 'ğŸŒ';
                    console.log('å·²åˆ‡æ¢åˆ°3Dè§†å›¾');
                } else {
                    // åˆ‡æ¢åˆ°2Dè§†å›¾
                    window.mapInstance.setViewMode('2D');
                    window.mapInstance.setPitch(0);
                    window.mapInstance.setRotation(0);
                    viewIcon.textContent = 'ğŸ—ºï¸';
                    console.log('å·²åˆ‡æ¢åˆ°2Dè§†å›¾');
                }
            };
            
            // åˆ‡æ¢å»ºç­‘ç‰¹æ•ˆ
            window.toggleBuildingEffect = function() {
                if (!window.mapInstance) return;
                
                window.effectsEnabled = !window.effectsEnabled;
                const effectIcon = document.getElementById('effect-icon');
                
                if (window.effectsEnabled) {
                    effectIcon.textContent = 'âœ¨';
                    // å¦‚æœæœ‰å½“å‰ä¼šè¯æ•°æ®ï¼Œé‡æ–°åŠ è½½ç‰¹æ•ˆ
                    const currentSession = localStorage.getItem('currentSession');
                    if (currentSession) {
                        loadLocationData(currentSession);
                    }
                    console.log('å»ºç­‘ç‰¹æ•ˆå·²å¼€å¯');
                } else {
                    effectIcon.textContent = 'ğŸ’«';
                    clearBuildingHighlight();
                    console.log('å»ºç­‘ç‰¹æ•ˆå·²å…³é—­');
                }
            };
            
            // æ‰“å¼€å…¨å±åœ°å›¾
            window.openFullscreenMap = function() {
                window.open('/3d-demo', '_blank');
            };
            
            // è§¦å‘åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
            window.dispatchEvent(new CustomEvent('amapLoaded', { detail: AMap }));
        }).catch((e) => {
            console.error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥:', e);
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const mapContainer = document.getElementById('amap-container');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            }
        });
    </script>
</body>
</html>
